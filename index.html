<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI Document Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, Segoe UI; margin: 24px; color: #111; }
    .wrap { max-width: 900px; margin: 0 auto; }
    h1 { margin-bottom: 8px; }
    p.sub { color: #666; margin-top: 0; }
    label { display:block; margin: 14px 0 6px; font-weight:500; }
    input[type=file], textarea, select {
      width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px;
    }
    textarea { font-family: ui-monospace, Consolas; }
    button { padding:10px 16px; border:0; border-radius:10px; background:#111; color:#fff; cursor:pointer; }
    button.secondary { background:#e9e9e9; color:#111; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:14px; }
    #status { color:#666; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>AI Document Analyzer</h1>
    <p class="sub">Upload a file, add optional instructions, and get an AI summary or insights. Hosted on Vercel.</p>

    <!-- Upload -->
    <label>Upload file</label>
    <input id="file" type="file"
           accept=".txt,.md,.csv,.json,.log,.pdf,.doc,.docx,.rtf,.xls,.xlsx,.ppt,.pptx,.html,.xml,.yaml,.yml" />

    <!-- Instructions -->
    <label>Instructions (optional)</label>
    <textarea id="instruction" rows="5" placeholder="e.g. Summarize key points, list risks, extract action items…"></textarea>

    <!-- Analyze Button -->
    <div class="row">
      <button id="analyzeBtn">Analyze</button>
      <span id="status"></span>
    </div>

    <!-- Result -->
    <label style="margin-top:18px;">Result</label>
    <textarea id="out" rows="14" placeholder="Results will appear here…"></textarea>

    <!-- ======= Download Section ======= -->
    <div style="display:flex;gap:10px;margin-top:14px;flex-wrap:wrap;">
      <input id="filename" type="text" value="analysis.txt"
             style="padding:10px;border:1px solid #ddd;border-radius:10px;min-width:220px" />
      <button id="downloadBtn"
              style="padding:10px 16px;border:0;border-radius:10px;background:#111;color:#fff;cursor:pointer;">
        Download Result
      </button>
      <span id="status2" style="align-self:center;color:#666"></span>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const API_URL = "/api/analyze";
    const MAX_MB = 20;

    const $ = (s) => document.querySelector(s);
    const setStatus = (m) => { const el = $("#status"); if (el) el.textContent = m || ""; };

    // ====== ANALYZE FUNCTION ======
    $("#analyzeBtn").addEventListener("click", async () => {
      const file = $("#file").files?.[0];
      const out = $("#out");
      const instruction = ($("#instruction").value || "").trim() || "Summarize this document.";

      if (!file) { out.value = "Pick a file first."; return; }
      if (file.size > MAX_MB * 1024 * 1024) {
        out.value = `File too large (max ${MAX_MB} MB).`; return;
      }

      setStatus("Uploading and analyzing…");
      out.value = "Analyzing…";

      try {
        const fd = new FormData();
        fd.append("file", file);
        fd.append("instruction", instruction);

        const res = await fetch(API_URL, { method: "POST", body: fd });
        let data; const text = await res.text();
        try { data = JSON.parse(text); } catch { data = { error: text }; }

        if (!res.ok) throw new Error(data?.error || "Request failed");
        out.value = (data?.result || "").trim() || "No result.";
        setStatus("Done");
      } catch (e) {
        out.value = "Error: " + e.message;
        setStatus("Failed");
      }
    });

    // ====== DOWNLOAD FUNCTION ======
    function inIframe() {
      try { return window.self !== window.top; } catch (_) { return true; }
    }

    function cleanFilename(name) {
      name = (name || "analysis.txt").trim();
      if (!/\.[a-z0-9]{1,8}$/i.test(name)) name += ".txt";
      return name.replace(/[^\w.\-]/g, "_");
    }

    document.getElementById("downloadBtn").addEventListener("click", () => {
      const text = document.getElementById("out").value || "";
      const filename = cleanFilename(document.getElementById("filename").value);

      if (!text.trim()) {
        const s = document.getElementById("status2");
        if (s) s.textContent = "Analyze something first.";
        return;
      }

      // Direct Vercel page → Blob download
      if (!inIframe()) {
        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } else {
        // Wix iframe fallback (just in case)
        const form = document.createElement("form");
        form.method = "POST";
        form.action = "/api/download";
        form.target = "_blank";
        form.style.display = "none";

        const f1 = document.createElement("input");
        f1.name = "filename";
        f1.value = filename;
        form.appendChild(f1);

        const f2 = document.createElement("textarea");
        f2.name = "text";
        f2.value = text;
        form.appendChild(f2);

        document.body.appendChild(form);
        form.submit();
        form.remove();
      }
    });
  </script>
</body>
</html>
